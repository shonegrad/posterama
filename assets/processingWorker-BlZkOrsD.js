(function(){"use strict";const Q=(c,n,l,o,s,a,u,k)=>{let g,i,m;const f=c/255,L=n/255,d=l/255,r=o/255,e=s/255,t=a/255;switch(u){case"multiply":g=f*r,i=L*e,m=d*t;break;case"screen":g=1-(1-f)*(1-r),i=1-(1-L)*(1-e),m=1-(1-d)*(1-t);break;case"overlay":g=f<.5?2*f*r:1-2*(1-f)*(1-r),i=L<.5?2*L*e:1-2*(1-L)*(1-e),m=d<.5?2*d*t:1-2*(1-d)*(1-t);break;case"soft-light":g=r<.5?2*f*r+f*f*(1-2*r):2*f*(1-r)+Math.sqrt(f)*(2*r-1),i=e<.5?2*L*e+L*L*(1-2*e):2*L*(1-e)+Math.sqrt(L)*(2*e-1),m=t<.5?2*d*t+d*d*(1-2*t):2*d*(1-t)+Math.sqrt(d)*(2*t-1);break;case"hard-light":g=r<.5?2*f*r:1-2*(1-f)*(1-r),i=e<.5?2*L*e:1-2*(1-L)*(1-e),m=t<.5?2*d*t:1-2*(1-d)*(1-t);break;case"color-dodge":g=f===1?1:Math.min(1,r/(1-f)),i=L===1?1:Math.min(1,e/(1-L)),m=d===1?1:Math.min(1,t/(1-d));break;case"color-burn":g=f===0?0:Math.max(0,1-(1-r)/f),i=L===0?0:Math.max(0,1-(1-e)/L),m=d===0?0:Math.max(0,1-(1-t)/d);break;case"darken":g=Math.min(f,r),i=Math.min(L,e),m=Math.min(d,t);break;case"lighten":g=Math.max(f,r),i=Math.max(L,e),m=Math.max(d,t);break;case"difference":g=Math.abs(f-r),i=Math.abs(L-e),m=Math.abs(d-t);break;case"exclusion":g=f+r-2*f*r,i=L+e-2*L*e,m=d+t-2*d*t;break;default:g=r,i=e,m=t;break}const h=k/100,b=Math.round((g*h+f*(1-h))*255),C=Math.round((i*h+L*(1-h))*255),p=Math.round((m*h+d*(1-h))*255);return[b,C,p]},K=new Map,Z=c=>{if(c===0)return{cos:1,sin:0};const n=Math.round(c);if(K.has(n))return K.get(n);const l=n*Math.PI/180,o={cos:Math.cos(l),sin:Math.sin(l)};return K.set(n,o),o},_=(c,n,l,o,s)=>{if(s===0)return[c,n];const{cos:a,sin:u}=Z(s),k=c-l,g=n-o,i=l+(k*a-g*u),m=o+(k*u+g*a);return[i,m]},E=(c,n,l)=>{if(l===0)return[c,n];const{cos:o,sin:s}=Z(l),a=c*o-n*s,u=c*s+n*o;return[a,u]},T=(c,n)=>(c%n+n)%n,$=(c,n,l,o,s,a,u,k,g,i,m,f,L=0)=>{const d=o*f,r=L*f,e=Math.max(2,d+r),t=Math.floor(c/e),h=Math.floor(n/e),b=t*e+e/2,C=h*e+e/2;let p=c,M=n;Math.abs(s)>1&&([p,M]=_(c,n,b,C,-s));const y=(p-b)**2+(M-C)**2,z=(d/2)**2*((255-l)/255)**2;return y<=z?[a,u,k]:[g,i,m]},G=(c,n,l,o,s,a,u,k,g,i,m,f,L=0)=>{const d=o*f,r=L*f,e=Math.max(2,d+r),[t,h]=E(c,n,-s),b=1-l/255,p=d*b,y=T(h,e),S=e/2;return Math.abs(y-S)<p/2?[a,u,k]:[g,i,m]},R=(c,n,l,o,s,a,u,k,g,i,m,f=0)=>{const d=((c*73+n*37+l)*9301+49297)%233280/233280,r=Math.max(0,1-f/20),e=1-l/255*.8*r;return d>e?[a,u,k]:[g,i,m]},j=(c,n,l,o,s,a,u,k,g,i,m,f,L=0)=>{const d=o*f,r=L*f,e=Math.max(2,d+r*2),t=1-l/255,[h,b]=E(c,n,-s),p=Math.max(1,e/20),M=T(b,e)<p,y=T(h,e)<p,S=T(h+b,e)<p,F=T(h-b,e)<p;let z=!1;return p>0&&(t>.75?z=M||y||S||F:t>.5?z=M||y||S:t>.25?z=M||y:z=M),z?[a,u,k]:[g,i,m]},tt=(c,n,l,o,s,a,u,k,g,i,m,f=0)=>{const d=(c*127+n*83)*16807%2147483647/2147483647,r=Math.max(0,1-f/20),e=(1-l/255)*.6*r;return d<e?[a,u,k]:[g,i,m]},ot=(c,n,l,o,s,a,u,k,g,i,m,f,L=0)=>{const d=o*f,r=L*f,e=Math.max(2,d+r),[t,h]=E(c,n,-s),b=Math.floor(t/e),C=Math.floor(h/e),p=t-b*e,M=h-C*e,y=e/2,S=e/2,F=Math.sqrt((p-y)**2+(M-S)**2),P=Math.abs(b*41+C*23)*12345%100/100,x=d/2*(1-l/255)*(.8+P*.4);return F<=x?[a,u,k]:[g,i,m]},et=(c,n,l,o,s,a,u,k,g,i,m,f=0)=>{const L=l*m,d=f*m,r=Math.max(2,L+d),[e,t]=E(c,n,-o),h=Math.floor(e/r),b=Math.floor(t/r),C=e-h*r,p=t-b*r,M=r/2,y=r/2,S=Math.sqrt((C-M)**2+(p-y)**2),F=L/2;return S<=F?[s,a,u]:[k,g,i]},nt=(c,n,l,o,s,a,u,k,g,i,m,f=0)=>{const L=l*m,d=f*m,r=Math.max(2,L+d),[e,t]=E(c,n,-o),h=L,b=T(t,r)<h,C=T(e,r)<h;return b||C?[s,a,u]:[k,g,i]},st=(c,n,l,o,s,a,u,k,g,i,m,f=0)=>{const L=l*m,d=f*m,r=Math.max(2,L+d*5),[e,t]=E(c,n,-o),h=2*Math.PI/r,b=Math.sin(e*h)*(r/6),C=Math.max(1,L),p=T(t,r)-r/2;return Math.abs(p-b)<C/2?[s,a,u]:[k,g,i]},rt=(c,n,l,o,s,a,u,k,g,i,m,f=0)=>{const L=l*m,d=f*m,r=L/2,e=r*2+d,[t,h]=E(c,n,-o),b=e,C=e*.866,p=Math.floor(t/(b*.75)),M=T(p,2),y=Math.floor((h-M*C*.5)/C),S=t-p*b*.75,F=h-y*C-M*C*.5,z=b*.375,P=C*.5;return Math.sqrt((S-z)**2+(F-P)**2)<=r?[s,a,u]:[k,g,i]},ct=(c,n,l,o,s,a,u,k,g,i,m,f=0)=>{const L=l*m,d=f*m,r=L,e=L*2,t=Math.max(1,d),h=r+t,b=e+t,[C,p]=E(c,n,-o),M=Math.floor(p/h),y=T(M,2),S=T(C+y*(b/2),b),F=T(p,h);return S<t||F<t?[k,g,i]:[s,a,u]},at=(c,n,l,o,s,a,u,k,g,i,m,f=0)=>{const L=l*m,d=f*m,r=L+d,[e,t]=E(c,n,-o),h=Math.floor(e/r),b=Math.floor(t/r),C=T(h,2),p=T(b,2);let M=C===p;if(M&&d>0){const y=e-h*r,S=t-b*r,F=d/2,z=F+L;(y<F||y>z||S<F||S>z)&&(M=!1)}return M?[s,a,u]:[k,g,i]},U=c=>{const n=parseInt(c.substring(1,3),16),l=parseInt(c.substring(3,5),16),o=parseInt(c.substring(5,7),16);return[n,l,o]},V=(c,n,l,o,s,a,u,k,g,i,m,f,L,d)=>{let r=m,e=f,t=L;if(o.usePattern&&o.pattern!=="none"){switch(o.pattern){case"halftone":[r,e,t]=$(c,n,l,o.patternSize,o.patternRotation,s,a,u,k,g,i,d,o.patternSpacing||0);break;case"screentone":[r,e,t]=G(c,n,l,o.patternSize,o.patternRotation,s,a,u,k,g,i,d,o.patternSpacing||0);break;case"noise":[r,e,t]=R(c,n,l,o.patternSize,o.patternRotation,s,a,u,k,g,i,o.patternSpacing||0);break;case"crosshatch":[r,e,t]=j(c,n,l,o.patternSize,o.patternRotation,s,a,u,k,g,i,d,o.patternSpacing||0);break;case"stippling":[r,e,t]=tt(c,n,l,o.patternSize,o.patternRotation,s,a,u,k,g,i,o.patternSpacing||0);break;case"newspaper":[r,e,t]=ot(c,n,l,o.patternSize,o.patternRotation,s,a,u,k,g,i,d,o.patternSpacing||0);break;case"dots":[r,e,t]=et(c,n,o.patternSize,o.patternRotation,s,a,u,k,g,i,d,o.patternSpacing||0);break;case"lines":[r,e,t]=nt(c,n,o.patternSize,o.patternRotation,s,a,u,k,g,i,d,o.patternSpacing||0);break;case"waves":[r,e,t]=st(c,n,o.patternSize,o.patternRotation,s,a,u,k,g,i,d,o.patternSpacing||0);break;case"hexagon":[r,e,t]=rt(c,n,o.patternSize,o.patternRotation,s,a,u,k,g,i,d,o.patternSpacing||0);break;case"brick":[r,e,t]=ct(c,n,o.patternSize,o.patternRotation,s,a,u,k,g,i,d,o.patternSpacing||0);break;case"fabric":[r,e,t]=at(c,n,o.patternSize,o.patternRotation,s,a,u,k,g,i,d,o.patternSpacing||0);break}return Q(m,f,L,r,e,t,o.blendMode,o.opacity)}else return Q(m,f,L,s,a,u,o.blendMode,o.opacity)},it=(c,n,l)=>{const o=new Uint8ClampedArray(c.data),s=new ImageData(c.width,c.height),a=s.data,u=c.width,k=c.height,g=n.map(r=>({fg:U(r.color),bg:U(r.patternBackgroundColor||r.color)})),i=n.length-1,m=n[i],f=g[i],d=n.slice(0,n.length-1).map((r,e)=>({layer:r,colors:g[e],index:e})).filter(r=>r.layer.visible!==!1);for(let r=0;r<k;r++)for(let e=0;e<u;e++){const t=(r*u+e)*4,h=o[t],b=o[t+1],C=o[t+2];o[t+3];const p=Math.round(.299*h+.587*b+.114*C);let M=0,y=0,S=0,F=0;m.visible!==!1&&([M,y,S]=V(e,r,p,{...m,opacity:100,blendMode:"normal"},f.fg[0],f.fg[1],f.fg[2],f.bg[0],f.bg[1],f.bg[2],0,0,0,l),F=m.opacity/100*255);for(const{layer:z,colors:P}of d)if(p<=(z.threshold||255)){const[D,x,X]=V(e,r,p,{...z,opacity:100},P.fg[0],P.fg[1],P.fg[2],P.bg[0],P.bg[1],P.bg[2],M,y,S,l),w=z.opacity/100;M=M*(1-w)+D*w,y=y*(1-w)+x*w,S=S*(1-w)+X*w,F=F+(255-F)*w;break}a[t]=M,a[t+1]=y,a[t+2]=S,a[t+3]=F}return s},dt=(c,n,l)=>{const o=new Uint8ClampedArray(c.data),s=c.width,a=c.height,u=n.map(t=>({fg:U(t.color),bg:U(t.patternBackgroundColor||t.color)})),k=n.length-1,g=n[k],i=u[k],f=n.slice(0,n.length-1).map((t,h)=>({layer:t,colors:u[h]})).filter(t=>t.layer.visible!==!1),L={layer:g,colors:i},d=new Float32Array(s*a);for(let t=0;t<s*a;t++){const h=t*4;d[t]=.299*o[h]+.587*o[h+1]+.114*o[h+2]}const r=new ImageData(s,a),e=r.data;for(let t=0;t<a;t++){const h=t%2===0?1:-1,b=t%2===0?0:s-1,C=t%2===0?s:-1;for(let p=b;p!==C;p+=h){const M=t*s+p,y=M*4,S=d[M];let F=L;for(const W of f)if(S<=(W.layer.threshold||255)){F=W;break}const z=F.layer,P=F.colors,D=z.threshold||128,x=S-D;let X=0,w=0,A=0,Y=0;if(g.visible!==!1&&([X,w,A]=V(p,t,Math.round(S),{...g,opacity:100,blendMode:"normal"},i.fg[0],i.fg[1],i.fg[2],i.bg[0],i.bg[1],i.bg[2],0,0,0,l),Y=g.opacity/100*255),z!==g&&z.visible!==!1){const[W,q,v]=V(p,t,Math.round(S),{...z,opacity:100},P.fg[0],P.fg[1],P.fg[2],P.bg[0],P.bg[1],P.bg[2],X,w,A,l),I=z.opacity/100;X=X*(1-I)+W*I,w=w*(1-I)+q*I,A=A*(1-I)+v*I,Y=Y+(255-Y)*I}e[y]=X,e[y+1]=w,e[y+2]=A,e[y+3]=Y,p+h>=0&&p+h<s&&(d[M+h]+=x*7/16),t<a-1&&(p-h>=0&&p-h<s&&(d[M+s-h]+=x*3/16),d[M+s]+=x*5/16,p+h>=0&&p+h<s&&(d[M+s+h]+=x*1/16))}}return r},lt=(c,n,l)=>{const o=new Uint8ClampedArray(c.data),s=c.width,a=c.height,u=n.map(t=>({fg:U(t.color),bg:U(t.patternBackgroundColor||t.color)})),k=n.length-1,g=n[k],i=u[k],f=n.slice(0,n.length-1).map((t,h)=>({layer:t,colors:u[h]})).filter(t=>t.layer.visible!==!1),L={layer:g,colors:i},d=[[0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]],r=new ImageData(s,a),e=r.data;for(let t=0;t<a;t++)for(let h=0;h<s;h++){const b=(t*s+h)*4,C=o[b],p=o[b+1],M=o[b+2],y=Math.round(.299*C+.587*p+.114*M),F=d[t%4][h%4]/15*64-32,z=Math.max(0,Math.min(255,y+F));let P=L;for(const W of f)if(z<=(W.layer.threshold||255)){P=W;break}const D=P.layer,x=P.colors;let X=0,w=0,A=0,Y=0;if(g.visible!==!1&&([X,w,A]=V(h,t,y,{...g,opacity:100,blendMode:"normal"},i.fg[0],i.fg[1],i.fg[2],i.bg[0],i.bg[1],i.bg[2],0,0,0,l),Y=g.opacity/100*255),D!==g&&D.visible!==!1){const[W,q,v]=V(h,t,y,{...D,opacity:100},x.fg[0],x.fg[1],x.fg[2],x.bg[0],x.bg[1],x.bg[2],X,w,A,l),I=D.opacity/100;X=X*(1-I)+W*I,w=w*(1-I)+q*I,A=A*(1-I)+v*I,Y=Y+(255-Y)*I}e[b]=X,e[b+1]=w,e[b+2]=A,e[b+3]=Y}return r},ht=(c,n,l)=>{const o=new Uint8ClampedArray(c.data),s=c.width,a=c.height,u=n.map(t=>({fg:U(t.color),bg:U(t.patternBackgroundColor||t.color)})),k=n.length-1,g=n[k],i=u[k],f=n.slice(0,n.length-1).map((t,h)=>({layer:t,colors:u[h]})).filter(t=>t.layer.visible!==!1),L={layer:g,colors:i},d=new Float32Array(s*a);for(let t=0;t<s*a;t++){const h=t*4;d[t]=.299*o[h]+.587*o[h+1]+.114*o[h+2]}const r=new ImageData(s,a),e=r.data;for(let t=0;t<a;t++)for(let h=0;h<s;h++){const b=t*s+h,C=b*4,p=d[b];let M=L;for(const A of f)if(p<=(A.layer.threshold||255)){M=A;break}const y=M.layer,S=M.colors,F=y.threshold||128,z=p-F;o[C],o[C+1],o[C+2];let P=0,D=0,x=0,X=0;if(g.visible!==!1&&([P,D,x]=V(h,t,Math.round(p),{...g,opacity:100,blendMode:"normal"},i.fg[0],i.fg[1],i.fg[2],i.bg[0],i.bg[1],i.bg[2],0,0,0,l),X=g.opacity/100*255),y!==g&&y.visible!==!1){const[A,Y,W]=V(h,t,Math.round(p),{...y,opacity:100},S.fg[0],S.fg[1],S.fg[2],S.bg[0],S.bg[1],S.bg[2],P,D,x,l),q=y.opacity/100;P=P*(1-q)+A*q,D=D*(1-q)+Y*q,x=x*(1-q)+W*q,X=X+(255-X)*q}e[C]=P,e[C+1]=D,e[C+2]=x,e[C+3]=X;const w=z/8;h<s-1&&(d[b+1]+=w),h<s-2&&(d[b+2]+=w),t<a-1&&(h>0&&(d[b+s-1]+=w),d[b+s]+=w,h<s-1&&(d[b+s+1]+=w)),t<a-2&&(d[b+s*2]+=w)}return r},N=(c,n,l,o,s)=>{const a=new Uint8ClampedArray(c.data),u=c.width,k=c.height,g=n.map(b=>({fg:U(b.color),bg:U(b.patternBackgroundColor||b.color)})),i=n.length-1,m=n[i],f=g[i],d=n.slice(0,n.length-1).map((b,C)=>({layer:b,colors:g[C]})).filter(b=>b.layer.visible!==!1),r={layer:m,colors:f},e=new Float32Array(u*k);for(let b=0;b<u*k;b++){const C=b*4;e[b]=.299*a[C]+.587*a[C+1]+.114*a[C+2]}const t=new ImageData(u,k),h=t.data;for(let b=0;b<k;b++)for(let C=0;C<u;C++){const p=b*u+C,M=p*4,y=e[p];let S=r;for(const Y of d)if(y<=(Y.layer.threshold||255)){S=Y;break}const F=S.layer,z=S.colors,P=F.threshold||128,D=y-P;a[M],a[M+1],a[M+2];let x=0,X=0,w=0,A=0;if(m.visible!==!1&&([x,X,w]=V(C,b,Math.round(y),{...m,opacity:100,blendMode:"normal"},f.fg[0],f.fg[1],f.fg[2],f.bg[0],f.bg[1],f.bg[2],0,0,0,s),A=m.opacity/100*255),F!==m&&F.visible!==!1){const[Y,W,q]=V(C,b,Math.round(y),{...F,opacity:100},z.fg[0],z.fg[1],z.fg[2],z.bg[0],z.bg[1],z.bg[2],x,X,w,s),v=F.opacity/100;x=x*(1-v)+Y*v,X=X*(1-v)+W*v,w=w*(1-v)+q*v,A=A+(255-A)*v}h[M]=x,h[M+1]=X,h[M+2]=w,h[M+3]=A;for(let Y=0;Y<l.length;Y++)for(let W=0;W<l[Y].length;W++){const q=l[Y][W];if(q===0)continue;const v=C+W-Math.floor(l[0].length/2),I=b+Y;if(v>=0&&v<u&&I>=0&&I<k){const H=I*u+v,J=D*q/o;e[H]+=J}}}return t},ut=(c,n,l)=>N(c,n,[[0,0,7,5],[3,5,7,5,3],[1,3,5,3,1]],48,l),gt=(c,n,l)=>N(c,n,[[0,0,5,3],[2,4,5,4,2],[0,2,3,2,0]],32,l),ft=(c,n,l)=>N(c,n,[[0,0,8,4],[2,4,8,4,2]],32,l),pt=(c,n,l)=>N(c,n,[[0,0,8,4],[2,4,8,4,2],[1,2,4,2,1]],42,l),bt=(c,n,l)=>{const o=new Uint8ClampedArray(c.data),s=c.width,a=c.height,u=n.map(p=>({fg:U(p.color),bg:U(p.patternBackgroundColor||p.color)})),k=n.length-1,g=n[k],i=u[k],f=n.slice(0,n.length-1).map((p,M)=>({layer:p,colors:u[M]})).filter(p=>p.layer.visible!==!1),L={layer:g,colors:i},d=new Array(Math.min(s,a)).fill(0),r=d.length;let e=0;const t=[],h=(p,M,y,S,F,z,P)=>{if(p<=0){const D=Math.floor(M+(S+z)/2),x=Math.floor(y+(F+P)/2);D>=0&&D<s&&x>=0&&x<a&&t.push([D,x])}else h(p-1,M,y,z/2,P/2,S/2,F/2),h(p-1,M+S/2,y+F/2,S/2,F/2,z/2,P/2),h(p-1,M+S/2+z/2,y+F/2+P/2,S/2,F/2,z/2,P/2),h(p-1,M+S/2+z,y+F/2+P,-z/2,-P/2,-S/2,-F/2)},b=Math.max(1,Math.floor(Math.log2(Math.max(s,a)))),C=Math.pow(2,b);if(h(b,0,0,C,0,0,C),t.length<s*a*.5){t.length=0;for(let p=0;p<a;p++)for(let M=0;M<s;M++)t.push([M,p])}for(const[p,M]of t){if(p>=s||M>=a)continue;const y=(M*s+p)*4,S=o[y],F=o[y+1],z=o[y+2],P=Math.round(.299*S+.587*F+.114*z),D=Math.max(0,Math.min(255,P+d[e]));let x=L;for(const H of f)if(D<=(H.layer.threshold||255)){x=H;break}const X=x.layer,w=x.colors,A=X.threshold||128,Y=D-A;let W=0,q=0,v=0,I=0;if(g.visible!==!1&&([W,q,v]=V(p,M,P,{...g,opacity:100,blendMode:"normal"},i.fg[0],i.fg[1],i.fg[2],i.bg[0],i.bg[1],i.bg[2],0,0,0,l),I=g.opacity/100*255),X!==g&&X.visible!==!1){const[H,J,O]=V(p,M,P,{...X,opacity:100},w.fg[0],w.fg[1],w.fg[2],w.bg[0],w.bg[1],w.bg[2],W,q,v,l),B=X.opacity/100;W=W*(1-B)+H*B,q=q*(1-B)+J*B,v=v*(1-B)+O*B,I=I+(255-I)*B}o[y]=W,o[y+1]=q,o[y+2]=v,o[y+3]=I,d[e]=0;for(let H=1;H<r&&H<16;H++){const J=(e+H)%r,O=Math.exp(-H/4);d[J]+=Y*O/4}e=(e+1)%r}return new ImageData(o,s,a)},Mt=(c,n,l)=>N(c,n,[[0,3],[3,2]],8,l),kt=(c,n,l)=>N(c,n,[[0,0,2],[1,1]],4,l);self.onmessage=c=>{const{type:n,imageData:l,algorithm:o,layers:s,previewScaleRatio:a}=c.data;if(n==="process")try{let u;switch(o){case"floyd-steinberg":u=dt(l,s,a);break;case"ordered-dither":u=lt(l,s,a);break;case"atkinson":u=ht(l,s,a);break;case"jarvis-judice-ninke":u=ut(l,s,a);break;case"sierra":u=gt(l,s,a);break;case"burkes":u=ft(l,s,a);break;case"stucki":u=pt(l,s,a);break;case"riemersma":u=bt(l,s,a);break;case"false-floyd-steinberg":u=Mt(l,s,a);break;case"sierra-lite":u=kt(l,s,a);break;default:u=it(l,s,a)}const k={type:"complete",imageData:u};self.postMessage(k,[u.data.buffer])}catch(u){const k={type:"error",error:u instanceof Error?u.message:"Unknown error"};self.postMessage(k)}}})();
